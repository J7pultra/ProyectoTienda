<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{fragments/layout :: layout(~{::title}, ~{::main})}">
<head>
    <title th:text="${titulo} + ' - Boutique Uniformes'">Cliente - Boutique Uniformes</title>
</head>
<body>
    <main th:fragment="content" class="fade-in">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb bg-white rounded shadow-sm p-3">
                <li class="breadcrumb-item">
                    <a th:href="@{/dashboard}" class="text-decoration-none">
                        <i class="fas fa-home me-1"></i>Inicio
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a th:href="@{/clientes}" class="text-decoration-none" th:text="#{nav.clientes}">Clientes</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page" th:text="${titulo}">Formulario</li>
            </ol>
        </nav>

        <!-- Header del formulario -->
        <div class="form-header mb-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="form-title">
                        <i class="fas fa-user-edit me-3 text-primary"></i>
                        <span th:text="${titulo}">Formulario Cliente</span>
                    </h1>
                    <p class="form-subtitle text-muted mb-0">
                        <span th:if="${cliente.id == null}" th:text="#{clientes.nuevo.descripcion}">
                            Completa la información para registrar un nuevo cliente
                        </span>
                        <span th:unless="${cliente.id == null}" th:text="#{clientes.editar.descripcion}">
                            Modifica la información del cliente
                        </span>
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a th:href="@{/clientes}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        <span th:text="#{btn.volver}">Volver</span>
                    </a>
                </div>
            </div>
        </div>

        <!-- Formulario -->
        <div class="row justify-content-center">
            <div class="col-xl-8 col-lg-10">
                <div class="card shadow">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-user-circle me-2"></i>
                            <span th:text="#{clientes.informacion.personal}">Información Personal</span>
                        </h6>
                    </div>
                    
                    <div class="card-body">
                        <form th:action="@{/clientes/guardar}" method="post" th:object="${cliente}" 
                              id="clienteForm" class="needs-validation" novalidate>
                            
                            <!-- ID oculto para edición -->
                            <input type="hidden" th:field="*{id}">
                            
                            <!-- Sección: Información Básica -->
                            <div class="form-section mb-4">
                                <h5 class="section-title">
                                    <i class="fas fa-id-card me-2"></i>
                                    <span th:text="#{clientes.info.basica}">Información Básica</span>
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="nombre" class="form-label required" th:text="#{form.nombre}">Nombre</label>
                                        <input type="text" class="form-control" id="nombre" th:field="*{nombre}" 
                                               th:placeholder="#{form.nombre.placeholder}" placeholder="Ingresa el nombre" required>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('nombre')}" th:errors="*{nombre}">
                                            Error en nombre
                                        </div>
                                        <div class="invalid-feedback" th:unless="${#fields.hasErrors('nombre')}">
                                            <span th:text="#{validation.nombre.requerido}">El nombre es requerido</span>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="apellido" class="form-label required" th:text="#{form.apellido}">Apellido</label>
                                        <input type="text" class="form-control" id="apellido" th:field="*{apellido}" 
                                               th:placeholder="#{form.apellido.placeholder}" placeholder="Ingresa el apellido" required>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('apellido')}" th:errors="*{apellido}">
                                            Error en apellido
                                        </div>
                                        <div class="invalid-feedback" th:unless="${#fields.hasErrors('apellido')}">
                                            <span th:text="#{validation.apellido.requerido}">El apellido es requerido</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="documento" class="form-label required" th:text="#{form.documento}">Documento</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-id-card"></i>
                                            </span>
                                            <input type="text" class="form-control" id="documento" th:field="*{documento}" 
                                                   th:placeholder="#{form.documento.placeholder}" placeholder="Número de documento" required>
                                        </div>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('documento')}" th:errors="*{documento}">
                                            Error en documento
                                        </div>
                                        <div class="invalid-feedback" th:unless="${#fields.hasErrors('documento')}">
                                            <span th:text="#{validation.documento.requerido}">El documento es requerido</span>
                                        </div>
                                        <div class="form-text" th:text="#{form.documento.ayuda}">
                                            Ingresa el número de cédula o documento de identidad
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="email" class="form-label" th:text="#{form.email}">Email</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-envelope"></i>
                                            </span>
                                            <input type="email" class="form-control" id="email" th:field="*{email}" 
                                                   th:placeholder="#{form.email.placeholder}" placeholder="correo@ejemplo.com">
                                        </div>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('email')}" th:errors="*{email}">
                                            Error en email
                                        </div>
                                        <div class="invalid-feedback" th:unless="${#fields.hasErrors('email')}">
                                            <span th:text="#{validation.email.formato}">Formato de email inválido</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sección: Información de Contacto -->
                            <div class="form-section mb-4">
                                <h5 class="section-title">
                                    <i class="fas fa-phone me-2"></i>
                                    <span th:text="#{clientes.info.contacto}">Información de Contacto</span>
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="telefono" class="form-label" th:text="#{form.telefono}">Teléfono</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-phone"></i>
                                            </span>
                                            <input type="tel" class="form-control" id="telefono" th:field="*{telefono}" 
                                                   th:placeholder="#{form.telefono.placeholder}" placeholder="123-456-7890">
                                        </div>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('telefono')}" th:errors="*{telefono}">
                                            Error en teléfono
                                        </div>
                                        <div class="form-text" th:text="#{form.telefono.ayuda}">
                                            Formato: 123-456-7890 o +57 123 456 7890
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3">
                                        <label for="ciudad" class="form-label" th:text="#{form.ciudad}">Ciudad</label>
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-map-marker-alt"></i>
                                            </span>
                                            <input type="text" class="form-control" id="ciudad" th:field="*{ciudad}" 
                                                   th:placeholder="#{form.ciudad.placeholder}" placeholder="Ciudad de residencia">
                                        </div>
                                        <div class="invalid-feedback" th:if="${#fields.hasErrors('ciudad')}" th:errors="*{ciudad}">
                                            Error en ciudad
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="direccion" class="form-label" th:text="#{form.direccion}">Dirección</label>
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-home"></i>
                                        </span>
                                        <textarea class="form-control" id="direccion" th:field="*{direccion}" rows="2"
                                                  th:placeholder="#{form.direccion.placeholder}" 
                                                  placeholder="Dirección completa de residencia"></textarea>
                                    </div>
                                    <div class="invalid-feedback" th:if="${#fields.hasErrors('direccion')}" th:errors="*{direccion}">
                                        Error en dirección
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Sección: Estado y Configuración -->
                            <div class="form-section mb-4" th:if="${cliente.id != null}">
                                <h5 class="section-title">
                                    <i class="fas fa-cog me-2"></i>
                                    <span th:text="#{clientes.configuracion}">Configuración</span>
                                </h5>
                                
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="activo" th:field="*{activo}">
                                            <label class="form-check-label" for="activo" th:text="#{form.cliente.activo}">
                                                Cliente Activo
                                            </label>
                                        </div>
                                        <div class="form-text" th:text="#{form.cliente.activo.ayuda}">
                                            Los clientes inactivos no aparecerán en las búsquedas principales
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6 mb-3" th:if="${cliente.fechaRegistro != null}">
                                        <label class="form-label" th:text="#{form.fecha.registro}">Fecha de Registro</label>
                                        <input type="text" class="form-control" readonly
                                               th:value="${#temporals.format(cliente.fechaRegistro, 'dd/MM/yyyy HH:mm')}">
                                        <div class="form-text" th:text="#{form.fecha.registro.ayuda}">
                                            Fecha en que se registró el cliente en el sistema
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Botones de acción -->
                            <div class="form-actions">
                                <div class="row">
                                    <div class="col-md-6">
                                        <button type="submit" class="btn btn-primary btn-lg w-100" id="btnGuardar">
                                            <i class="fas fa-save me-2"></i>
                                            <span th:if="${cliente.id == null}" th:text="#{btn.crear.cliente}">Crear Cliente</span>
                                            <span th:unless="${cliente.id == null}" th:text="#{btn.actualizar.cliente}">Actualizar Cliente</span>
                                        </button>
                                    </div>
                                    <div class="col-md-6">
                                        <a th:href="@{/clientes}" class="btn btn-outline-secondary btn-lg w-100">
                                            <i class="fas fa-times me-2"></i>
                                            <span th:text="#{btn.cancelar}">Cancelar</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Información adicional para edición -->
                <div class="card shadow mt-4" th:if="${cliente.id != null}">
                    <div class="card-header py-3">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="fas fa-info-circle me-2"></i>
                            <span th:text="#{clientes.info.adicional}">Información Adicional</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="info-item">
                                    <div class="info-label" th:text="#{clientes.total.compras}">Total de Compras</div>
                                    <div class="info-value">$0</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-item">
                                    <div class="info-label" th:text="#{clientes.ultima.compra}">Última Compra</div>
                                    <div class="info-value">-</div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="info-item">
                                    <div class="info-label" th:text="#{clientes.numero.compras}">Número de Compras</div>
                                    <div class="info-value">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- CSS específico -->
    <th:block th:fragment="css">
        <style>
            .form-header {
                background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(255, 255, 255, 0.95) 100%);
                border-radius: 15px;
                padding: 2rem;
                border: 1px solid rgba(79, 70, 229, 0.1);
            }
            
            .form-title {
                font-size: 2.25rem;
                font-weight: 700;
                color: #1e293b;
                margin-bottom: 0.5rem;
            }
            
            .form-section {
                border-bottom: 1px solid #f1f5f9;
                padding-bottom: 1.5rem;
            }
            
            .form-section:last-child {
                border-bottom: none;
                padding-bottom: 0;
            }
            
            .section-title {
                color: #4f46e5;
                font-weight: 600;
                font-size: 1.1rem;
                margin-bottom: 1.5rem;
                padding-bottom: 0.5rem;
                border-bottom: 2px solid #e5e7eb;
                display: flex;
                align-items: center;
            }
            
            .form-label.required::after {
                content: ' *';
                color: #ef4444;
                font-weight: bold;
            }
            
            .form-control, .form-select {
                border-radius: 8px;
                border: 2px solid #e5e7eb;
                padding: 0.75rem 1rem;
                transition: all 0.3s ease;
            }
            
            .form-control:focus, .form-select:focus {
                border-color: #4f46e5;
                box-shadow: 0 0 0 0.2rem rgba(79, 70, 229, 0.25);
            }
            
            .input-group-text {
                background: #f8fafc;
                border: 2px solid #e5e7eb;
                border-right: none;
                color: #6b7280;
            }
            
            .input-group .form-control {
                border-left: none;
            }
            
            .input-group:focus-within .input-group-text {
                border-color: #4f46e5;
                background: rgba(79, 70, 229, 0.05);
                color: #4f46e5;
            }
            
            .form-actions {
                background: #f8fafc;
                border-radius: 12px;
                padding: 2rem;
                margin-top: 2rem;
            }
            
            .info-item {
                text-align: center;
                padding: 1rem;
                background: #f8fafc;
                border-radius: 8px;
                margin-bottom: 1rem;
            }
            
            .info-label {
                font-size: 0.875rem;
                color: #6b7280;
                margin-bottom: 0.5rem;
                text-transform: uppercase;
                letter-spacing: 0.05em;
            }
            
            .info-value {
                font-size: 1.25rem;
                font-weight: 600;
                color: #1e293b;
            }
            
            .form-check-input:checked {
                background-color: #4f46e5;
                border-color: #4f46e5;
            }
            
            .form-text {
                font-size: 0.8rem;
                color: #6b7280;
                margin-top: 0.25rem;
            }
            
            @media (max-width: 768px) {
                .form-title {
                    font-size: 1.75rem;
                }
                
                .form-header {
                    padding: 1.5rem;
                }
                
                .form-actions .row > div {
                    margin-bottom: 1rem;
                }
            }
        </style>
    </th:block>

    <!-- JavaScript específico -->
    <th:block th:fragment="scripts">
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('clienteForm');
                const documentoInput = document.getElementById('documento');
                const emailInput = document.getElementById('email');
                const telefonoInput = document.getElementById('telefono');
                
                // Validación del documento
                documentoInput.addEventListener('blur', function() {
                    validateDocumento(this.value);
                });
                
                // Formateo del teléfono
                telefonoInput.addEventListener('input', function() {
                    formatTelefono(this);
                });
                
                // Validación del formulario
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        // Mostrar primer campo inválido
                        const firstInvalid = form.querySelector(':invalid');
                        if (firstInvalid) {
                            firstInvalid.focus();
                            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    } else {
                        // Mostrar loading en el botón
                        const btnGuardar = document.getElementById('btnGuardar');
                        btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
                        btnGuardar.disabled = true;
                    }
                    
                    form.classList.add('was-validated');
                });
                
                // Animación de entrada
                const card = document.querySelector('.card');
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                
                setTimeout(() => {
                    card.style.transition = 'all 0.6s ease';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100);
            });
            
            function validateDocumento(documento) {
                if (!documento) return;
                
                // Simular validación de documento existente
                fetch(`/api/clientes/validate-documento?documento=${documento}`)
                    .then(response => response.json())
                    .then(data => {
                        const input = document.getElementById('documento');
                        if (data.exists) {
                            input.setCustomValidity('Ya existe un cliente con este documento');
                            input.classList.add('is-invalid');
                            showNotification('Ya existe un cliente con este documento', 'warning');
                        } else {
                            input.setCustomValidity('');
                            input.classList.remove('is-invalid');
                            input.classList.add('is-valid');
                        }
                    })
                    .catch(error => {
                        console.error('Error validando documento:', error);
                    });
            }
            
            function formatTelefono(input) {
                let value = input.value.replace(/\D/g, '');
                
                if (value.length >= 10) {
                    value = value.substring(0, 10);
                    value = value.replace(/(\d{3})(\d{3})(\d{4})/, '$1-$2-$3');
                } else if (value.length >= 6) {
                    value = value.replace(/(\d{3})(\d{3})(\d+)/, '$1-$2-$3');
                } else if (value.length >= 3) {
                    value = value.replace(/(\d{3})(\d+)/, '$1-$2');
                }
                
                input.value = value;
            }
        </script>
    </th:block>
</body>
</html>
