<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="~{fragments/layout :: layout(~{::title}, ~{::main})}">
<head>
    <title th:text="${titulo} + ' - Boutique Uniformes'">Nueva Venta - Boutique Uniformes</title>
</head>
<body>
    <main th:fragment="content" class="fade-in">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb bg-white rounded shadow-sm p-3">
                <li class="breadcrumb-item">
                    <a th:href="@{/dashboard}" class="text-decoration-none">
                        <i class="fas fa-home me-1"></i>Inicio
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a th:href="@{/ventas}" class="text-decoration-none" th:text="#{nav.ventas}">Ventas</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page" th:text="${titulo}">Nueva Venta</li>
            </ol>
        </nav>

        <!-- Header del formulario -->
        <div class="form-header mb-4">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="form-title">
                        <i class="fas fa-shopping-cart me-3 text-primary"></i>
                        <span th:text="${titulo}">Nueva Venta</span>
                    </h1>
                    <p class="form-subtitle text-muted mb-0" th:text="#{ventas.nueva.descripcion}">
                        Registra una nueva venta seleccionando productos y cliente
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="sale-info">
                        <div class="sale-number">
                            <strong th:text="#{ventas.numero.factura}">Número de Factura:</strong>
                            <span class="badge bg-primary fs-6" th:text="${venta.numeroFactura ?: 'FAC-' + #temporals.format(#temporals.createNow(), 'yyyyMMdd') + '-001'}">FAC-20240101-001</span>
                        </div>
                        <div class="sale-date">
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>
                                <span th:text="${#temporals.format(#temporals.createNow(), 'dd/MM/yyyy HH:mm')}">01/01/2024 10:30</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario de venta -->
        <form th:action="@{/ventas/guardar}" method="post" th:object="${venta}" 
              id="ventaForm" class="needs-validation" novalidate>
            
            <!-- ID oculto para edición -->
            <input type="hidden" th:field="*{id}">
            
            <div class="row">
                <!-- Columna izquierda - Información del cliente y vendedor -->
                <div class="col-lg-4">
                    <!-- Información del Cliente -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-user me-2"></i>
                                <span th:text="#{ventas.info.cliente}">Información del Cliente</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="clienteId" class="form-label required" th:text="#{form.cliente}">Cliente</label>
                                <div class="input-group">
                                    <select class="form-select" id="clienteId" th:field="*{cliente.id}" required>
                                        <option value="" th:text="#{form.seleccionar.cliente}">Seleccionar cliente...</option>
                                        <option th:each="cliente : ${clientes}" th:value="${cliente.id}" 
                                                th:text="${cliente.nombreCompleto + ' - ' + cliente.documento}">
                                            Cliente - Documento
                                        </option>
                                    </select>
                                    <button type="button" class="btn btn-outline-primary" onclick="nuevoClienteRapido()">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('cliente')}" th:errors="*{cliente}">
                                    Error en cliente
                                </div>
                                <div class="invalid-feedback" th:unless="${#fields.hasErrors('cliente')}">
                                    <span th:text="#{validation.cliente.requerido}">Debe seleccionar un cliente</span>
                                </div>
                            </div>
                            
                            <!-- Información del cliente seleccionado -->
                            <div id="clienteInfo" class="client-info" style="display: none;">
                                <div class="alert alert-info">
                                    <div class="row">
                                        <div class="col-12">
                                            <strong th:text="#{form.nombre}">Nombre:</strong>
                                            <span id="clienteNombre">-</span>
                                        </div>
                                        <div class="col-12">
                                            <strong th:text="#{form.documento}">Documento:</strong>
                                            <span id="clienteDocumento">-</span>
                                        </div>
                                        <div class="col-12">
                                            <strong th:text="#{form.telefono}">Teléfono:</strong>
                                            <span id="clienteTelefono">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Información del Vendedor -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-user-tie me-2"></i>
                                <span th:text="#{ventas.info.vendedor}">Información del Vendedor</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="vendedorId" class="form-label" th:text="#{form.vendedor}">Vendedor</label>
                                <select class="form-select" id="vendedorId" th:field="*{vendedor.id}">
                                    <option value="" th:text="#{form.seleccionar.vendedor}">Seleccionar vendedor...</option>
                                    <option th:each="vendedor : ${vendedores}" th:value="${vendedor.id}" 
                                            th:text="${vendedor.nombreCompleto + ' - ' + vendedor.cargo}">
                                        Vendedor - Cargo
                                    </option>
                                </select>
                                <div class="form-text" th:text="#{form.vendedor.ayuda}">
                                    Si no se selecciona, se asignará automáticamente
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="fechaVenta" class="form-label required" th:text="#{form.fecha.venta}">Fecha de Venta</label>
                                <input type="datetime-local" class="form-control" id="fechaVenta" th:field="*{fechaVenta}" required>
                                <div class="invalid-feedback" th:if="${#fields.hasErrors('fechaVenta')}" th:errors="*{fechaVenta}">
                                    Error en fecha
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Resumen de la Venta -->
                    <div class="card shadow">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-calculator me-2"></i>
                                <span th:text="#{ventas.resumen}">Resumen de la Venta</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="summary-item">
                                <div class="d-flex justify-content-between">
                                    <span th:text="#{ventas.subtotal}">Subtotal:</span>
                                    <span id="subtotalDisplay" class="fw-bold">$0</span>
                                </div>
                            </div>
                            
                            <div class="summary-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span th:text="#{ventas.descuento}">Descuento:</span>
                                    <div class="input-group input-group-sm" style="width: 100px;">
                                        <input type="number" class="form-control" id="descuentoPorcentaje" 
                                               min="0" max="100" value="0" step="0.01">
                                        <span class="input-group-text">%</span>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted">-<span id="descuentoAmount">$0</span></small>
                                </div>
                            </div>
                            
                            <div class="summary-item">
                                <div class="d-flex justify-content-between">
                                    <span th:text="#{ventas.impuesto}">Impuesto (19%):</span>
                                    <span id="impuestoDisplay" class="fw-bold">$0</span>
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div class="summary-item">
                                <div class="d-flex justify-content-between">
                                    <span class="fs-5 fw-bold" th:text="#{ventas.total}">Total:</span>
                                    <span id="totalDisplay" class="fs-4 fw-bold text-success">$0</span>
                                </div>
                            </div>
                            
                            <!-- Campos ocultos para enviar al servidor -->
                            <input type="hidden" id="subtotalHidden" th:field="*{subtotal}">
                            <input type="hidden" id="descuentoHidden" th:field="*{descuento}">
                            <input type="hidden" id="impuestoHidden" th:field="*{impuesto}">
                            <input type="hidden" id="totalHidden" th:field="*{total}">
                        </div>
                    </div>
                </div>
                
                <!-- Columna derecha - Productos -->
                <div class="col-lg-8">
                    <div class="card shadow">
                        <div class="card-header py-3 d-flex justify-content-between align-items-center">
                            <h6 class="m-0 font-weight-bold text-primary">
                                <i class="fas fa-shopping-bag me-2"></i>
                                <span th:text="#{ventas.productos}">Productos de la Venta</span>
                            </h6>
                            <button type="button" class="btn btn-success btn-sm" onclick="agregarProducto()">
                                <i class="fas fa-plus me-1"></i>
                                <span th:text="#{btn.agregar.producto}">Agregar Producto</span>
                            </button>
                        </div>
                        <div class="card-body">
                            <!-- Buscador de productos -->
                            <div class="product-search mb-4">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="productSearch" 
                                           placeholder="Buscar producto por nombre, código o categoría...">
                                    <button type="button" class="btn btn-outline-primary" onclick="buscarProductos()">
                                        <span th:text="#{btn.buscar}">Buscar</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Lista de productos seleccionados -->
                            <div id="productosContainer">
                                <div class="table-responsive">
                                    <table class="table table-hover" id="productosTable">
                                        <thead class="table-light">
                                            <tr>
                                                <th th:text="#{table.producto}">Producto</th>
                                                <th th:text="#{table.precio}">Precio</th>
                                                <th th:text="#{table.cantidad}">Cantidad</th>
                                                <th th:text="#{table.subtotal}">Subtotal</th>
                                                <th class="text-center" th:text="#{table.acciones}">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody id="productosTableBody">
                                            <tr id="emptyRow">
                                                <td colspan="5" class="text-center text-muted py-4">
                                                    <i class="fas fa-shopping-bag fa-2x mb-2"></i>
                                                    <div th:text="#{ventas.sin.productos}">No hay productos agregados</div>
                                                    <small th:text="#{ventas.sin.productos.descripcion}">
                                                        Busca y agrega productos para crear la venta
                                                    </small>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Observaciones -->
                            <div class="mt-4">
                                <label for="observaciones" class="form-label" th:text="#{form.observaciones}">Observaciones</label>
                                <textarea class="form-control" id="observaciones" th:field="*{observaciones}" rows="3"
                                          th:placeholder="#{ventas.observaciones.placeholder}" 
                                          placeholder="Comentarios adicionales sobre la venta..."></textarea>
                                <div class="form-text" th:text="#{form.observaciones.ayuda}">
                                    Información adicional sobre la venta (opcional)
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Botones de acción -->
            <div class="form-actions mt-4">
                <div class="row">
                    <div class="col-md-6">
                        <button type="submit" class="btn btn-success btn-lg w-100" id="btnGuardar">
                            <i class="fas fa-save me-2"></i>
                            <span th:text="#{btn.procesar.venta}">Procesar Venta</span>
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button type="button" class="btn btn-outline-primary btn-lg w-100" onclick="guardarBorrador()">
                            <i class="fas fa-file-alt me-2"></i>
                            <span th:text="#{btn.guardar.borrador}">Guardar Borrador</span>
                        </button>
                    </div>
                    <div class="col-md-3">
                        <a th:href="@{/ventas}" class="btn btn-outline-secondary btn-lg w-100">
                            <i class="fas fa-times me-2"></i>
                            <span th:text="#{btn.cancelar}">Cancelar</span>
                        </a>
                    </div>
                </div>
            </div>
        </form>
        
        <!-- Modal para búsqueda de productos -->
        <div class="modal fade" id="productSearchModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-search me-2"></i>
                            <span th:text="#{ventas.buscar.productos}">Buscar Productos</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="modalProductSearch" 
                                   placeholder="Buscar por nombre, código o categoría...">
                        </div>
                        <div id="productSearchResults" class="product-grid">
                            <!-- Los resultados se cargarán aquí -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal para nuevo cliente rápido -->
        <div class="modal fade" id="nuevoClienteModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-user-plus me-2"></i>
                            <span th:text="#{ventas.nuevo.cliente.rapido}">Nuevo Cliente Rápido</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="nuevoClienteForm">
                            <div class="mb-3">
                                <label for="clienteNombreModal" class="form-label required">Nombre</label>
                                <input type="text" class="form-control" id="clienteNombreModal" required>
                            </div>
                            <div class="mb-3">
                                <label for="clienteApellidoModal" class="form-label required">Apellido</label>
                                <input type="text" class="form-control" id="clienteApellidoModal" required>
                            </div>
                            <div class="mb-3">
                                <label for="clienteDocumentoModal" class="form-label required">Documento</label>
                                <input type="text" class="form-control" id="clienteDocumentoModal" required>
                            </div>
                            <div class="mb-3">
                                <label for="clienteTelefonoModal" class="form-label">Teléfono</label>
                                <input type="tel" class="form-control" id="clienteTelefonoModal">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="guardarClienteRapido()">
                            <i class="fas fa-save me-1"></i>
                            Guardar Cliente
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- CSS específico -->
    <th:block th:fragment="css">
        <style>
            .form-header {
                background: linear-gradient(135deg, rgba(79, 70, 229, 0.05) 0%, rgba(255, 255, 255, 0.95) 100%);
                border-radius: 15px;
                padding: 2rem;
                border: 1px solid rgba(79, 70, 229, 0.1);
            }
            
            .form-title {
                font-size: 2.25rem;
                font-weight: 700;
                color: #1e293b;
                margin-bottom: 0.5rem;
            }
            
            .sale-info {
                text-align: center;
                background: rgba(79, 70, 229, 0.1);
                border-radius: 12px;
                padding: 1rem;
            }
            
            .sale-number {
                margin-bottom: 0.5rem;
            }
            
            .form-label.required::after {
                content: ' *';
                color: #ef4444;
                font-weight: bold;
            }
            
            .client-info {
                background: #f8fafc;
                border-radius: 12px;
                padding: 1rem;
                margin-top: 1rem;
                border: 1px solid #e5e7eb;
            }
            
            .summary-item {
                padding: 0.75rem 0;
                border-bottom: 1px solid #f1f5f9;
            }
            
            .summary-item:last-child {
                border-bottom: none;
            }
            
            .product-search {
                background: #f8fafc;
                border-radius: 12px;
                padding: 1rem;
                border: 1px solid #e5e7eb;
            }
            
            .product-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 1rem;
                max-height: 400px;
                overflow-y: auto;
            }
            
            .product-card {
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                padding: 1rem;
                cursor: pointer;
                transition: all 0.3s ease;
                background: white;
            }
            
            .product-card:hover {
                border-color: #4f46e5;
                box-shadow: 0 4px 12px rgba(79, 70, 229, 0.15);
                transform: translateY(-2px);
            }
            
            .product-card.selected {
                border-color: #4f46e5;
                background: rgba(79, 70, 229, 0.05);
            }
            
            .product-name {
                font-weight: 600;
                color: #1e293b;
                margin-bottom: 0.5rem;
            }
            
            .product-code {
                font-size: 0.8rem;
                color: #6b7280;
                font-family: 'Courier New', monospace;
            }
            
            .product-price {
                font-size: 1.1rem;
                font-weight: 700;
                color: #059669;
                margin-top: 0.5rem;
            }
            
            .product-stock {
                font-size: 0.8rem;
                color: #6b7280;
            }
            
            .form-actions {
                background: #f8fafc;
                border-radius: 12px;
                padding: 2rem;
                border: 1px solid #e5e7eb;
            }
            
            .table th {
                border-top: none;
                font-weight: 600;
                color: #374151;
                background-color: #f8fafc;
                padding: 1rem 0.75rem;
            }
            
            .table td {
                padding: 1rem 0.75rem;
                vertical-align: middle;
                border-color: #f1f5f9;
            }
            
            .quantity-controls {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            
            .quantity-btn {
                width: 30px;
                height: 30px;
                border-radius: 50%;
                border: 1px solid #e5e7eb;
                background: white;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            
            .quantity-btn:hover {
                background: #4f46e5;
                color: white;
                border-color: #4f46e5;
            }
            
            .quantity-input {
                width: 60px;
                text-align: center;
                border: 1px solid #e5e7eb;
                border-radius: 6px;
                padding: 0.25rem;
            }
            
            @media (max-width: 768px) {
                .form-title {
                    font-size: 1.75rem;
                }
                
                .form-header {
                    padding: 1.5rem;
                }
                
                .form-actions .row > div {
                    margin-bottom: 1rem;
                }
                
                .product-grid {
                    grid-template-columns: 1fr;
                }
                
                .table-responsive {
                    font-size: 0.875rem;
                }
            }
        </style>
    </th:block>

    <!-- JavaScript específico -->
    <th:block th:fragment="scripts">
        <script>
            let productosVenta = [];
            let productosDisponibles = [];
            
            document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('ventaForm');
                const clienteSelect = document.getElementById('clienteId');
                const fechaVentaInput = document.getElementById('fechaVenta');
                const descuentoInput = document.getElementById('descuentoPorcentaje');
                
                // Establecer fecha actual por defecto
                if (!fechaVentaInput.value) {
                    const now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    fechaVentaInput.value = now.toISOString().slice(0, 16);
                }
                
                // Cargar productos disponibles
                cargarProductosDisponibles();
                
                // Eventos
                clienteSelect.addEventListener('change', function() {
                    if (this.value) {
                        cargarInfoCliente(this.value);
                    } else {
                        ocultarInfoCliente();
                    }
                });
                
                descuentoInput.addEventListener('input', function() {
                    calcularTotales();
                });
                
                // Validación del formulario
                form.addEventListener('submit', function(event) {
                    if (!validarFormulario()) {
                        event.preventDefault();
                        event.stopPropagation();
                    } else {
                        // Preparar datos para envío
                        prepararDatosVenta();
                        
                        // Mostrar loading
                        const btnGuardar = document.getElementById('btnGuardar');
                        btnGuardar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Procesando...';
                        btnGuardar.disabled = true;
                    }
                    
                    form.classList.add('was-validated');
                });
                
                // Búsqueda de productos en tiempo real
                const productSearch = document.getElementById('productSearch');
                productSearch.addEventListener('input', debounce(function() {
                    if (this.value.length >= 2) {
                        buscarProductosEnTiempoReal(this.value);
                    }
                }, 300));
                
                // Animación de entrada
                const cards = document.querySelectorAll('.card');
                cards.forEach((card, index) => {
                    card.style.opacity = '0';
                    card.style.transform = 'translateY(20px)';
                    
                    setTimeout(() => {
                        card.style.transition = 'all 0.6s ease';
                        card.style.opacity = '1';
                        card.style.transform = 'translateY(0)';
                    }, index * 100);
                });
            });
            
            function cargarProductosDisponibles() {
                fetch('/api/uniformes/disponibles')
                    .then(response => response.json())
                    .then(productos => {
                        productosDisponibles = productos;
                    })
                    .catch(error => {
                        console.error('Error cargando productos:', error);
                        showNotification('Error cargando productos disponibles', 'error');
                    });
            }
            
            function cargarInfoCliente(clienteId) {
                fetch(`/api/clientes/${clienteId}`)
                    .then(response => response.json())
                    .then(cliente => {
                        document.getElementById('clienteNombre').textContent = cliente.nombreCompleto || '-';
                        document.getElementById('clienteDocumento').textContent = cliente.documento || '-';
                        document.getElementById('clienteTelefono').textContent = cliente.telefono || '-';
                        document.getElementById('clienteInfo').style.display = 'block';
                    })
                    .catch(error => {
                        console.error('Error cargando información del cliente:', error);
                        ocultarInfoCliente();
                    });
            }
            
            function ocultarInfoCliente() {
                document.getElementById('clienteInfo').style.display = 'none';
            }
            
            function agregarProducto() {
                const modal = new bootstrap.Modal(document.getElementById('productSearchModal'));
                modal.show();
                
                // Cargar productos en el modal
                mostrarProductosEnModal(productosDisponibles);
            }
            
            function mostrarProductosEnModal(productos) {
                const container = document.getElementById('productSearchResults');
                container.innerHTML = '';
                
                if (productos.length === 0) {
                    container.innerHTML = `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-search fa-2x mb-2"></i>
                            <div>No se encontraron productos</div>
                        </div>
                    `;
                    return;
                }
                
                productos.forEach(producto => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card';
                    productCard.onclick = () => seleccionarProducto(producto);
                    
                    productCard.innerHTML = `
                        <div class="product-name">${producto.nombre}</div>
                        <div class="product-code">Código: ${producto.codigo}</div>
                        <div class="product-price">$${formatNumber(producto.precio)}</div>
                        <div class="product-stock">Stock: ${producto.stock} unidades</div>
                        <div class="mt-2">
                            <span class="badge bg-secondary">${producto.categoria}</span>
                            <span class="badge bg-info">${producto.talla}</span>
                        </div>
                    `;
                    
                    container.appendChild(productCard);
                });
            }
            
            function seleccionarProducto(producto) {
                // Verificar si el producto ya está en la venta
                const productoExistente = productosVenta.find(p => p.id === producto.id);
                
                if (productoExistente) {
                    showNotification('Este producto ya está agregado a la venta', 'warning');
                    return;
                }
                
                // Agregar producto a la venta
                const productoVenta = {
                    id: producto.id,
                    nombre: producto.nombre,
                    codigo: producto.codigo,
                    precio: producto.precio,
                    cantidad: 1,
                    stock: producto.stock,
                    subtotal: producto.precio
                };
                
                productosVenta.push(productoVenta);
                actualizarTablaProductos();
                calcularTotales();
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('productSearchModal'));
                modal.hide();
                
                showNotification(`Producto "${producto.nombre}" agregado a la venta`, 'success');
            }
            
            function actualizarTablaProductos() {
                const tbody = document.getElementById('productosTableBody');
                const emptyRow = document.getElementById('emptyRow');
                
                // Limpiar tabla
                tbody.innerHTML = '';
                
                if (productosVenta.length === 0) {
                    tbody.appendChild(emptyRow);
                    return;
                }
                
                productosVenta.forEach((producto, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <div>
                                <div class="fw-bold">${producto.nombre}</div>
                                <small class="text-muted">${producto.codigo}</small>
                            </div>
                        </td>
                        <td>
                            <span class="fw-bold">$${formatNumber(producto.precio)}</span>
                        </td>
                        <td>
                            <div class="quantity-controls">
                                <button type="button" class="quantity-btn" onclick="cambiarCantidad(${index}, -1)">
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" class="quantity-input" value="${producto.cantidad}" 
                                       min="1" max="${producto.stock}" 
                                       onchange="actualizarCantidad(${index}, this.value)">
                                <button type="button" class="quantity-btn" onclick="cambiarCantidad(${index}, 1)">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <small class="text-muted d-block">Stock: ${producto.stock}</small>
                        </td>
                        <td>
                            <span class="fw-bold text-success">$${formatNumber(producto.subtotal)}</span>
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                    onclick="eliminarProducto(${index})" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
            
            function cambiarCantidad(index, cambio) {
                const producto = productosVenta[index];
                const nuevaCantidad = producto.cantidad + cambio;
                
                if (nuevaCantidad >= 1 && nuevaCantidad <= producto.stock) {
                    actualizarCantidad(index, nuevaCantidad);
                }
            }
            
            function actualizarCantidad(index, nuevaCantidad) {
                const producto = productosVenta[index];
                nuevaCantidad = parseInt(nuevaCantidad);
                
                if (nuevaCantidad < 1) {
                    nuevaCantidad = 1;
                } else if (nuevaCantidad > producto.stock) {
                    nuevaCantidad = producto.stock;
                    showNotification(`Stock máximo disponible: ${producto.stock}`, 'warning');
                }
                
                producto.cantidad = nuevaCantidad;
                producto.subtotal = producto.precio * nuevaCantidad;
                
                actualizarTablaProductos();
                calcularTotales();
            }
            
            function eliminarProducto(index) {
                const producto = productosVenta[index];
                
                Swal.fire({
                    title: '¿Eliminar producto?',
                    text: `¿Estás seguro de eliminar "${producto.nombre}" de la venta?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        productosVenta.splice(index, 1);
                        actualizarTablaProductos();
                        calcularTotales();
                        showNotification('Producto eliminado de la venta', 'success');
                    }
                });
            }
            
            function calcularTotales() {
                const subtotal = productosVenta.reduce((sum, producto) => sum + producto.subtotal, 0);
                const descuentoPorcentaje = parseFloat(document.getElementById('descuentoPorcentaje').value) || 0;
                const descuentoAmount = subtotal * (descuentoPorcentaje / 100);
                const baseImponible = subtotal - descuentoAmount;
                const impuesto = baseImponible * 0.19; // 19% IVA
                const total = baseImponible + impuesto;
                
                // Actualizar displays
                document.getElementById('subtotalDisplay').textContent = '$' + formatNumber(subtotal);
                document.getElementById('descuentoAmount').textContent = '$' + formatNumber(descuentoAmount);
                document.getElementById('impuestoDisplay').textContent = '$' + formatNumber(impuesto);
                document.getElementById('totalDisplay').textContent = '$' + formatNumber(total);
                
                // Actualizar campos ocultos
                document.getElementById('subtotalHidden').value = subtotal.toFixed(2);
                document.getElementById('descuentoHidden').value = descuentoAmount.toFixed(2);
                document.getElementById('impuestoHidden').value = impuesto.toFixed(2);
                document.getElementById('totalHidden').value = total.toFixed(2);
            }
            
            function buscarProductosEnTiempoReal(query) {
                const resultados = productosDisponibles.filter(producto => 
                    producto.nombre.toLowerCase().includes(query.toLowerCase()) ||
                    producto.codigo.toLowerCase().includes(query.toLowerCase()) ||
                    producto.categoria.toLowerCase().includes(query.toLowerCase())
                );
                
                // Mostrar sugerencias (implementar dropdown de sugerencias)
                console.log('Resultados de búsqueda:', resultados);
            }
            
            function buscarProductos() {
                const query = document.getElementById('modalProductSearch').value;
                const resultados = productosDisponibles.filter(producto => 
                    producto.nombre.toLowerCase().includes(query.toLowerCase()) ||
                    producto.codigo.toLowerCase().includes(query.toLowerCase()) ||
                    producto.categoria.toLowerCase().includes(query.toLowerCase())
                );
                
                mostrarProductosEnModal(resultados);
            }
            
            function nuevoClienteRapido() {
                const modal = new bootstrap.Modal(document.getElementById('nuevoClienteModal'));
                modal.show();
            }
            
            function guardarClienteRapido() {
                const form = document.getElementById('nuevoClienteForm');
                const formData = new FormData(form);
                
                const cliente = {
                    nombre: document.getElementById('clienteNombreModal').value,
                    apellido: document.getElementById('clienteApellidoModal').value,
                    documento: document.getElementById('clienteDocumentoModal').value,
                    telefono: document.getElementById('clienteTelefonoModal').value
                };
                
                if (!cliente.nombre || !cliente.apellido || !cliente.documento) {
                    showNotification('Complete los campos requeridos', 'warning');
                    return;
                }
                
                fetch('/api/clientes/rapido', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(cliente)
                })
                .then(response => response.json())
                .then(nuevoCliente => {
                    // Agregar cliente al select
                    const clienteSelect = document.getElementById('clienteId');
                    const option = document.createElement('option');
                    option.value = nuevoCliente.id;
                    option.textContent = `${nuevoCliente.nombreCompleto} - ${nuevoCliente.documento}`;
                    clienteSelect.appendChild(option);
                    
                    // Seleccionar el nuevo cliente
                    clienteSelect.value = nuevoCliente.id;
                    cargarInfoCliente(nuevoCliente.id);
                    
                    // Cerrar modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('nuevoClienteModal'));
                    modal.hide();
                    
                    // Limpiar formulario
                    form.reset();
                    
                    showNotification('Cliente creado y seleccionado exitosamente', 'success');
                })
                .catch(error => {
                    console.error('Error creando cliente:', error);
                    showNotification('Error al crear el cliente', 'error');
                });
            }
            
            function validarFormulario() {
                const clienteId = document.getElementById('clienteId').value;
                
                if (!clienteId) {
                    showNotification('Debe seleccionar un cliente', 'warning');
                    return false;
                }
                
                if (productosVenta.length === 0) {
                    showNotification('Debe agregar al menos un producto a la venta', 'warning');
                    return false;
                }
                
                return true;
            }
            
            function prepararDatosVenta() {
                // Crear campos ocultos para los productos
                const form = document.getElementById('ventaForm');
                
                // Limpiar productos anteriores
                const existingProductInputs = form.querySelectorAll('input[name^="detalles"]');
                existingProductInputs.forEach(input => input.remove());
                
                // Agregar productos actuales
                productosVenta.forEach((producto, index) => {
                    const inputs = [
                        { name: `detalles[${index}].uniforme.id`, value: producto.id },
                        { name: `detalles[${index}].cantidad`, value: producto.cantidad },
                        { name: `detalles[${index}].precioUnitario`, value: producto.precio },
                        { name: `detalles[${index}].subtotal`, value: producto.subtotal }
                    ];
                    
                    inputs.forEach(inputData => {
                        const input = document.createElement('input');
                        input.type = 'hidden';
                        input.name = inputData.name;
                        input.value = inputData.value;
                        form.appendChild(input);
                    });
                });
            }
            
            function guardarBorrador() {
                if (!validarFormulario()) {
                    return;
                }
                
                prepararDatosVenta();
                
                // Agregar campo para indicar que es borrador
                const borradorInput = document.createElement('input');
                borradorInput.type = 'hidden';
                borradorInput.name = 'borrador';
                borradorInput.value = 'true';
                document.getElementById('ventaForm').appendChild(borradorInput);
                
                showNotification('Guardando borrador...', 'info');
                document.getElementById('ventaForm').submit();
            }
            
            function formatNumber(number) {
                return new Intl.NumberFormat('es-CO').format(number);
            }
            
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }
        </script>
    </th:block>
</body>
</html>
